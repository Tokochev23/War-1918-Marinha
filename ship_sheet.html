<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha do Navio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/ship_sheet.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="sheet-container" id="sheet-container">
        <header class="sheet-header">
            <h1 id="ship_name_header">Carregando...</h1>
            <p id="ship_class_header"></p>
        </header>

        <main class="sheet-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Coluna da Esquerda: Stats Principais -->
                <section class="stats-section">
                    <h2 class="section-title"><i class="fas fa-chart-bar mr-2"></i>Características Principais</h2>
                    <div class="stats-grid">
                        <div class="stat-item"><span><i class="fas fa-tag fa-fw mr-2"></i>Custo</span><strong id="stat_cost"></strong></div>
                        <div class="stat-item"><span><i class="fas fa-weight-hanging fa-fw mr-2"></i>Deslocamento</span><strong id="stat_tonnage"></strong></div>
                        <div class="stat-item"><span><i class="fas fa-tachometer-alt fa-fw mr-2"></i>Velocidade Máx.</span><strong id="stat_speed"></strong></div>
                        <div class="stat-item"><span><i class="fas fa-route fa-fw mr-2"></i>Alcance</span><strong id="stat_range"></strong></div>
                        <div class="stat-item"><span><i class="fas fa-shield-alt fa-fw mr-2"></i>Blindagem Efetiva</span><strong id="stat_armor"></strong></div>
                        <div class="stat-item"><span><i class="fas fa-heartbeat fa-fw mr-2"></i>Confiabilidade</span><strong id="stat_reliability"></strong></div>
                    </div>
                </section>

                <!-- Coluna da Direita: Capacidades de Combate -->
                <section class="stats-section">
                    <h2 class="section-title"><i class="fas fa-fist-raised mr-2"></i>Capacidades de Combate</h2>
                    <div class="stats-grid">
                        <div class="stat-item"><span><i class="fas fa-bomb fa-fw mr-2"></i>Poder de Fogo</span><strong id="stat_firepower"></strong></div>
                        <div class="stat-item"><span><i class="fas fa-plane-slash fa-fw mr-2"></i>Defesa Antiaérea</span><strong id="stat_aa"></strong></div>
                        <div class="stat-item"><span><i class="fas fa-water fa-fw mr-2"></i>Guerra Antissubmarino</span><strong id="stat_asw"></strong></div>
                    </div>
                </section>
            </div>

            <!-- Seção de Armamentos -->
            <section class="details-section">
                <h2 class="section-title"><i class="fas fa-crosshairs mr-2"></i>Armamentos Instalados</h2>
                <table class="details-table">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Descrição</th>
                        </tr>
                    </thead>
                    <tbody id="armaments_table_body">
                        <!-- Preenchido por JS -->
                    </tbody>
                </table>
            </section>

            <!-- Seção de Componentes -->
            <section class="details-section">
                <h2 class="section-title"><i class="fas fa-cogs mr-2"></i>Componentes e Sistemas</h2>
                <table class="details-table">
                    <thead>
                        <tr>
                            <th>Sistema</th>
                            <th>Seleção</th>
                        </tr>
                    </thead>
                    <tbody id="components_table_body">
                        <!-- Preenchido por JS -->
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <div class="actions-panel">
        <button id="save_png_button" class="action-button"><i class="fas fa-camera mr-2"></i>Salvar como PNG</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const shipDataString = localStorage.getItem('shipSheetData');
            if (!shipDataString) {
                document.body.innerHTML = '<h1>Erro: Nenhum dado de navio encontrado. Por favor, crie um navio primeiro.</h1>';
                return;
            }

            const design = JSON.parse(shipDataString);
            const { state, calculated, data } = design;
            const hullData = data.hulls[state.hull];

            // Preencher Cabeçalho
            document.getElementById('ship_name_header').textContent = state.shipName;
            document.getElementById('ship_class_header').textContent = `${hullData.name} (${state.sliders.displacement}%)`;

            // Preencher Stats Principais
            document.getElementById('stat_cost').textContent = `£${Math.round(calculated.cost).toLocaleString('pt-BR')}`;
            document.getElementById('stat_tonnage').textContent = `${Math.round(calculated.tonnage).toLocaleString('pt-BR')} t`;
            document.getElementById('stat_speed').textContent = `${Math.round(calculated.finalSpeed)} nós`;
            document.getElementById('stat_range').textContent = `${state.sliders.range.toLocaleString('pt-BR')} km`;
            const armorData = data.armor[state.armor.type];
            const effectiveArmor = Math.round(state.armor.thickness * (armorData.effectiveness || 0));
            document.getElementById('stat_armor').textContent = `${effectiveArmor} mm`;
            document.getElementById('stat_reliability').textContent = `${Math.round(calculated.finalReliability)}%`;

            // Preencher Capacidades de Combate
            document.getElementById('stat_firepower').textContent = Math.round(calculated.firepower);
            document.getElementById('stat_aa').textContent = Math.round(calculated.aa_rating);
            document.getElementById('stat_asw').textContent = Math.round(calculated.asw_rating);

            // Preencher Tabela de Armamentos
            const armamentsBody = document.getElementById('armaments_table_body');
            state.armaments.forEach(arm => {
                const row = armamentsBody.insertRow();
                let desc = '';
                if(arm.type === 'gun_turret') {
                    desc = `${arm.turrets}x Torre(s) c/ ${arm.barrels} Canhão(s) de ${arm.caliber}mm (${arm.mark})`;
                } else {
                    desc = `1x Lançador c/ ${arm.tubes} Torpedo(s) (${arm.mark})`;
                }
                row.innerHTML = `<td>${arm.type === 'gun_turret' ? 'Canhão' : 'Torpedo'}</td><td>${desc}</td>`;
            });

            // Preencher Tabela de Componentes
            const componentsBody = document.getElementById('components_table_body');
            for(const categoryKey in data.components) {
                const category = data.components[categoryKey];
                 for (const compKey in category.options) {
                    if(state.components[compKey]) {
                        const optionData = category.options[compKey];
                        const selectedOption = optionData.options[state.components[compKey]];
                        const row = componentsBody.insertRow();
                        row.innerHTML = `<td>${optionData.name}</td><td>${selectedOption.name}</td>`;
                    }
                }
            }
             const engineRow = componentsBody.insertRow();
             engineRow.innerHTML = `<td>Motor Principal</td><td>${calculated.engineName || 'N/A'}</td>`;


            // Funcionalidade do Botão de Salvar PNG
            document.getElementById('save_png_button').addEventListener('click', () => {
                const sheetElement = document.getElementById('sheet-container');
                html2canvas(sheetElement, { scale: 2, useCORS: true, backgroundColor: '#f3f4f6' }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `${state.shipName.replace(/ /g, '_')}_Ficha.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                });
            });
        });
    </script>
</body>
</html>
